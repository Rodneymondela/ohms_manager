<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHMS Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Bootstrap CSS for better styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">OHMS Manager</a>
                <div class="navbar-nav ms-auto">
                    {% if current_user.is_authenticated %}
                        <span class="navbar-text me-3">Welcome, {{ current_user.username }}</span>
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    {% else %}
                        <a class="nav-link" href="{{ url_for('login') }}">Login</a>
                        <a class="nav-link" href="{{ url_for('register') }}">Register</a>
                    {% endif %}
                </div>
            </div>
        </nav>

        <!-- Flash Messages -->
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <!-- Main Content (only shown when logged in) -->
        {% if current_user.is_authenticated %}
        <div class="row">
            <!-- Forms Column -->
            <div class="col-md-4">
                <!-- Add Employee Form -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h2>Add Employee</h2>
                    </div>
                    <div class="card-body">
                        <form id="addEmployeeForm">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="name" placeholder="Name" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="job_title" placeholder="Job Title" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="department" placeholder="Department" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Employee</button>
                        </form>
                    </div>
                </div>

                <!-- Add Hazard Form -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h2>Add Hazard</h2>
                    </div>
                    <div class="card-body">
                        <form id="addHazardForm">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="hazard_name" placeholder="Hazard Name" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="category" placeholder="Category" required>
                            </div>
                            <div class="mb-3">
                                <input type="number" class="form-control" id="exposure_limit" placeholder="Exposure Limit" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Hazard</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Second Forms Column -->
            <div class="col-md-4">
                <!-- Record Exposure Form -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h2>Record Exposure</h2>
                    </div>
                    <div class="card-body">
                        <form id="addExposureForm">
                            <div class="mb-3">
                                <input type="number" class="form-control" id="employee_id" placeholder="Employee ID" required>
                            </div>
                            <div class="mb-3">
                                <input type="number" class="form-control" id="hazard_id" placeholder="Hazard ID" required>
                            </div>
                            <div class="mb-3">
                                <input type="number" class="form-control" id="exposure_level" placeholder="Exposure Level" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Record Exposure</button>
                        </form>
                    </div>
                </div>

                <!-- Add Health Record Form -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h2>Add Health Record</h2>
                    </div>
                    <div class="card-body">
                        <form id="addHealthRecordForm">
                            <div class="mb-3">
                                <input type="number" class="form-control" id="health_employee_id" placeholder="Employee ID" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="test_type" placeholder="Test Type" required>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="result" placeholder="Result" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Health Record</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tables Column -->
            <div class="col-md-8">
                <!-- Employees Table -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h2>Employees</h2>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped" id="employeeTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Job Title</th>
                                    <th>Department</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Employee data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Hazards Table -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h2>Hazards</h2>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped" id="hazardTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Exposure Limit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Hazard data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Additional Tables -->
            <div class="col-md-6">
                <!-- Exposures Table -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h2>Exposures</h2>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped" id="exposureTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Employee ID</th>
                                    <th>Hazard ID</th>
                                    <th>Exposure Level</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Exposure data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- Health Records Table -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h2>Health Records</h2>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped" id="healthRecordTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Employee ID</th>
                                    <th>Test Type</th>
                                    <th>Result</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Health record data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            Please <a href="{{ url_for('login') }}" class="alert-link">login</a> to access the OHMS Manager.
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Function to show alert for API responses
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.flash-messages').appendChild(alertDiv);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }

        // Function to fetch and display data
        async function fetchData(endpoint, tableId, columns) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const tableBody = document.querySelector(`#${tableId} tbody`);
                
                tableBody.innerHTML = data.map(item => {
                    let row = '<tr>';
                    columns.forEach(col => {
                        // Handle nested objects or special formatting
                        let value = item[col];
                        if (value === null || value === undefined) value = '';
                        if (col === 'date' && value) {
                            value = new Date(value).toLocaleString();
                        }
                        row += `<td>${value}</td>`;
                    });
                    return row + '</tr>';
                }).join('');
            } catch (error) {
                console.error('Error fetching data:', error);
                showAlert(`Failed to load data: ${error.message}`, 'danger');
            }
        }

        // Function to handle form submission
        async function handleFormSubmit(formId, endpoint, successMessage) {
            const form = document.getElementById(formId);
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {};
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.id) {
                        formData[input.id] = input.value;
                    }
                });
                
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Request failed');
                    }
                    
                    const data = await response.json();
                    showAlert(successMessage);
                    form.reset();
                    
                    // Refresh relevant tables
                    if (formId === 'addEmployeeForm') {
                        fetchData('/api/employees', 'employeeTable', ['id', 'name', 'job_title', 'department']);
                    } else if (formId === 'addHazardForm') {
                        fetchData('/api/hazards', 'hazardTable', ['id', 'name', 'category', 'exposure_limit']);
                    } else if (formId === 'addExposureForm') {
                        fetchData('/api/exposures', 'exposureTable', ['id', 'employee_id', 'hazard_id', 'exposure_level', 'date']);
                    } else if (formId === 'addHealthRecordForm') {
                        fetchData('/api/health_records', 'healthRecordTable', ['id', 'employee_id', 'test_type', 'result', 'date']);
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                }
            });
        }

        // Initialize the page when loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (document.querySelector('#employeeTable')) {
                fetchData('/api/employees', 'employeeTable', ['id', 'name', 'job_title', 'department']);
                fetchData('/api/hazards', 'hazardTable', ['id', 'name', 'category', 'exposure_limit']);
                fetchData('/api/exposures', 'exposureTable', ['id', 'employee_id', 'hazard_id', 'exposure_level', 'date']);
                fetchData('/api/health_records', 'healthRecordTable', ['id', 'employee_id', 'test_type', 'result', 'date']);
                
                // Set up form handlers
                handleFormSubmit('addEmployeeForm', '/api/employees', 'Employee added successfully!');
                handleFormSubmit('addHazardForm', '/api/hazards', 'Hazard added successfully!');
                handleFormSubmit('addExposureForm', '/api/exposures', 'Exposure recorded successfully!');
                handleFormSubmit('addHealthRecordForm', '/api/health_records', 'Health record added successfully!');
            }
        });
    </script>
</body>
</html>